{% extends "section.html" %}

{#
Variables:
  start_week_index = index of earliest week marked as 22/23 in data (~start of aug, week -8)
  end_week_index = index of last week marked as 22/23 in data (~end of sept, week 52)
  year_start = date of start of week 0 - start of the teaching year
  start_cal_week = calendar week of week 0 (term week and cal week difference)
#}

{% block secbody %}
{{ resource.content | safe}}

{% set data = load_data(url="https://tabula.warwick.ac.uk/api/v1/termdates/weeks", format="json") %}
<ul>
{# Get start of year week #}
{% for w in data.weeks %}
  {# Find index of earliest week of academic year (~start of august) #}
  {% if w.academicYear == config.extra.academic_year and not start_week_index %}
    {% set_global start_week_index = loop.index0 %}
  {% endif %}
  {# Find index of week 0 (start of term) #}
  {% if w.academicYear == config.extra.academic_year and w.weekNumber == 0 %}
      {% set_global year_start = w.start %}
      {% break %}
  {% endif %}
{% endfor %}

{% set start_cal_week= year_start | date(format="%W") | int %}

{# Find index of latest week of academic year (~end of sept, should be week 0 + 52) #}
{% for w in data.weeks | slice(start=start_week_index) %}
{% if w.academicYear != config.extra.academic_year %}
    {% set_global end_week_index = start_week_index + loop.index0 - 1 %}
    {% break %}
{% endif %}
{% endfor %}
</ul>

{# {{ year_start }} i {{ start_week_index }} yw {{ start_cal_week}}<br> #}
{# ei {{ end_week_index }}<br> #}

{# Initial week #}
{% set prev_week_index = start_week_index-1 %}
{% set prev_week_number = -1 %}
{% set prev_week_term = "" %}

{# Output each event #}
<ul>
{% for e in section.pages | reverse %}
  {# Get event week #}
  {% set e_cal_week = e.date | date(format="%W") | int %}
  {% set e_week = e_cal_week - start_cal_week%}
  {% set e_week = (e_week+52) % 52 %}
  {% if e.date | date(format="%s") | int < year_start | date(format="%s") | int %}
    {% set e_week = e_week - 52 %}
  {% endif %}
  
  {# If different from last, end current week's list then start new #}
  {% if e_week != prev_week_number %}
    </ul>
    {% for w in data.weeks | slice(start=prev_week_index, end=end_week_index+2) %}
      {# Find week (after current) with correct week number #}
      {% if loop.index == end_week_index+1 %}{{ throw(message="Event outside of term weeks") }}{% endif %}
      {% if e_week == w.weekNumber %}
        {% set_global curr_week = w %}
        {% set_global curr_week_index = prev_week_index + loop.index0 %}
      {% endif %}
    {% endfor %}
    
    {% if prev_week_index > end_week_index %}
      OUT OF WEEKS IN YEAR!<br>
    {% endif %}

    {# Output week header #}
    {% set w = data.weeks[prev_week_index] %}
    {% set w_parts = w.name | split(pat=", ") %}
    {% if w.weekNumber == 0 %}<h1>Welcome Week</h1>
    {% elif w_parts[0] != prev_week_term %}<h1>{{ w_parts[0] }}</h1>
    {% endif %}
    <h4>{{ w.name }}</h4>{# wi {{prev_week_index}} wn {{prev_week_number}} {{ w.weekNumber }} {{ w.start }} {{ w.end }}#}
    <ul>

    {% set_global prev_week_index = curr_week_index %}
    {% set_global prev_week_number = curr_week.weekNumber %}
    {% set_global prev_week_term = w_parts[0] %}
  {% endif %}
  {# Output event info #}
  <li>{# ew {{ e_week }} {{ e.date }} #}{{ e.date | date(format="%a") }}: {{ e.title }}</li>
{% endfor %}
</ul>

{% endblock %}
